<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Detection API Client Demo</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            @apply px-6 py-3 rounded-lg font-semibold text-white transition-colors duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700;
        }
        .btn-info {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
        }
        .message-success { @apply bg-green-100 text-green-800 border border-green-300; }
        .message-error { @apply bg-red-100 text-red-800 border border-red-300; }
        .message-info { @apply bg-blue-100 text-blue-800 border border-blue-300; }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .label {
            @apply block text-gray-700 text-sm font-medium mb-1;
        }
        .response-box {
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-8 text-blue-800">Fruit Detection API Client Demo</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Authentication Section -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 section-title">üîë Authentication</h2>
                <div class="mb-4">
                    <label for="authOption" class="label">Choose an option:</label>
                    <select id="authOption" class="input-field">
                        <option value="login">Login</option>
                        <option value="register">Register</option>
                    </select>
                </div>

                <div id="loginForm" class="auth-form">
                    <h3 class="text-xl font-medium mb-3">Login</h3>
                    <div class="mb-4">
                        <label for="loginUsername" class="label">Username:</label>
                        <input type="text" id="loginUsername" class="input-field" value="adminuser">
                    </div>
                    <div class="mb-6">
                        <label for="loginPassword" class="label">Password:</label>
                        <input type="password" id="loginPassword" class="input-field" value="adminpassword">
                    </div>
                    <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                </div>

                <div id="registerForm" class="auth-form hidden">
                    <h3 class="text-xl font-medium mb-3">Register New User</h3>
                    <div class="mb-4">
                        <label for="registerUsername" class="label">New Username:</label>
                        <input type="text" id="registerUsername" class="input-field">
                    </div>
                    <div class="mb-4">
                        <label for="registerPassword" class="label">New Password:</label>
                        <input type="password" id="registerPassword" class="input-field">
                    </div>
                    <div class="mb-6">
                        <label for="registerRole" class="label">Select Role:</label>
                        <select id="registerRole" class="input-field">
                            <option value="viewer">viewer</option>
                            <option value="annotator">annotator</option>
                            <option value="admin">admin</option>
                        </select>
                    </div>
                    <button id="registerBtn" class="btn btn-success w-full">Register</button>
                </div>

                <div id="authStatus" class="message-box message-info hidden"></div>
                <div id="loggedInUser" class="mt-4 p-3 bg-blue-50 rounded-lg text-blue-800 font-medium hidden"></div>
                <button id="logoutBtn" class="btn btn-danger mt-4 w-full hidden">Logout</button>
            </div>

            <!-- Prediction Section -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 section-title">üß† Fruit Prediction</h2>
                <div class="mb-4">
                    <label for="modelSelect" class="label">Select Model:</label>
                    <select id="modelSelect" class="input-field">
                        <option value="YOLOv10m">YOLOv10m</option>
                        <option value="YOLOv9c">YOLOv9c</option>
                        <option value="YOLOv10l">YOLOv10l</option>
                        <option value="FasterRCNN">FasterRCNN</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="imageUpload" class="label">Upload Image:</label>
                    <input type="file" id="imageUpload" accept="image/jpeg, image/png" class="input-field p-2">
                </div>
                <button id="predictBtn" class="btn btn-primary w-full">Run Prediction</button>
                <div id="predictionStatus" class="message-box hidden"></div>
                <div id="predictionResult" class="response-box hidden"></div>
                <img id="annotatedImage" class="mt-4 w-full rounded-lg shadow-md hidden" alt="Annotated Image">
            </div>
        </div>

        <!-- Role-Restricted Actions Section -->
        <div class="mt-8 bg-gray-50 p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 section-title">üîí Role-Restricted Actions (Admin/Annotator)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <button id="trainBtn" class="btn btn-info w-full">üìä Train Models (Admin Only)</button>
                    <div id="trainStatus" class="message-box hidden"></div>
                </div>
                <div>
                    <input type="text" id="deleteRecordId" class="input-field mb-2" placeholder="Record ID to Delete">
                    <button id="deleteBtn" class="btn btn-info w-full">üóëÔ∏è Delete Record (Admin Only)</button>
                    <div id="deleteStatus" class="message-box hidden"></div>
                </div>
                <div>
                    <button id="correctBtn" class="btn btn-info w-full">‚úçÔ∏è Correct Predictions (Annotator/Admin Only)</button>
                    <div id="correctStatus" class="message-box hidden"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Configuration
        const FASTAPI_URL = "http://localhost:8000"; // Ensure this matches your FastAPI host:port

        // DOM Elements
        const authOption = document.getElementById('authOption');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const registerRole = document.getElementById('registerRole');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authStatus = document.getElementById('authStatus');
        const loggedInUser = document.getElementById('loggedInUser');

        const modelSelect = document.getElementById('modelSelect');
        const imageUpload = document.getElementById('imageUpload');
        const predictBtn = document.getElementById('predictBtn');
        const predictionStatus = document.getElementById('predictionStatus');
        const predictionResult = document.getElementById('predictionResult');
        const annotatedImage = document.getElementById('annotatedImage');

        const trainBtn = document.getElementById('trainBtn');
        const trainStatus = document.getElementById('trainStatus');
        const deleteRecordId = document.getElementById('deleteRecordId');
        const deleteBtn = document.getElementById('deleteBtn');
        const deleteStatus = document.getElementById('deleteStatus');
        const correctBtn = document.getElementById('correctBtn');
        const correctStatus = document.getElementById('correctStatus');

        // Global state for authentication token
        let authToken = "";
        let currentUsername = "";
        let currentUserRole = "";

        // --- Utility Functions ---

        function displayMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = `message-box message-${type}`;
            element.classList.remove('hidden');
        }

        function clearMessage(element) {
            element.textContent = '';
            element.classList.add('hidden');
        }

        function updateAuthUI() {
            if (authToken) {
                loggedInUser.textContent = `Logged in as ${currentUsername} (${currentUserRole})`;
                loggedInUser.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                authOption.classList.add('hidden'); // Hide option once logged in
                clearMessage(authStatus);
            } else {
                loggedInUser.textContent = '';
                loggedInUser.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                authOption.classList.remove('hidden'); // Show option if logged out
                // Show either login or register form based on selected option
                if (authOption.value === 'login') {
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                } else {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                }
            }
        }

        // --- Event Listeners ---

        authOption.addEventListener('change', () => {
            if (authOption.value === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
            clearMessage(authStatus);
        });

        loginBtn.addEventListener('click', async () => {
            clearMessage(authStatus);
            const username = loginUsername.value;
            const password = loginPassword.value;

            try {
                const response = await fetch(`${FASTAPI_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    currentUsername = data.username;
                    currentUserRole = data.role;
                    displayMessage(authStatus, `Logged in as ${currentUsername} (${currentUserRole})`, 'success');
                    updateAuthUI();
                } else {
                    displayMessage(authStatus, `Login failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(authStatus, `Network error or server unreachable: ${error.message}`, 'error');
            }
        });

        registerBtn.addEventListener('click', async () => {
            clearMessage(authStatus);
            const username = registerUsername.value;
            const password = registerPassword.value;
            const role = registerRole.value;

            try {
                const response = await fetch(`${FASTAPI_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(authStatus, `User '${username}' registered successfully as '${role}'. You can now log in.`, 'success');
                    registerUsername.value = '';
                    registerPassword.value = '';
                } else {
                    displayMessage(authStatus, `Registration failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(authStatus, `Network error or server unreachable: ${error.message}`, 'error');
            }
        });

        logoutBtn.addEventListener('click', () => {
            authToken = "";
            currentUsername = "";
            currentUserRole = "";
            displayMessage(authStatus, "Logged out successfully.", 'info');
            updateAuthUI();
            // Clear prediction results as well
            clearMessage(predictionStatus);
            predictionResult.classList.add('hidden');
            annotatedImage.classList.add('hidden');
        });

        predictBtn.addEventListener('click', async () => {
            clearMessage(predictionStatus);
            predictionResult.classList.add('hidden');
            annotatedImage.classList.add('hidden');

            if (!authToken) {
                displayMessage(predictionStatus, "Please log in first to run predictions.", 'error');
                return;
            }

            const selectedModel = modelSelect.value;
            const imageFile = imageUpload.files[0];

            if (!imageFile) {
                displayMessage(predictionStatus, "Please select an image file.", 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('model_names', selectedModel); // FastAPI expects a list, but Form handles single value
            formData.append('image_filename', imageFile.name);

            try {
                displayMessage(predictionStatus, "Running prediction...", 'info');
                const response = await fetch(`${FASTAPI_URL}/predict`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage(predictionStatus, "Prediction successful!", 'success');
                    predictionResult.textContent = JSON.stringify(data, null, 2);
                    predictionResult.classList.remove('hidden');

                    // Assuming FastAPI returns a base64 encoded image or a URL
                    // For this demo, we'll just show the text result.
                    // If your FastAPI returns an image, you'd decode and display it here.
                    // Example if FastAPI returned base64 image:
                    // if (data.annotated_image_base64) {
                    //     annotatedImage.src = `data:image/png;base64,${data.annotated_image_base64}`;
                    //     annotatedImage.classList.remove('hidden');
                    // }

                } else {
                    displayMessage(predictionStatus, `Prediction failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(predictionStatus, `Network error or server unreachable: ${error.message}`, 'error');
            }
        });

        // --- Role-Restricted Actions ---

        trainBtn.addEventListener('click', async () => {
            clearMessage(trainStatus);
            if (!authToken) {
                displayMessage(trainStatus, "Please log in first.", 'error');
                return;
            }
            try {
                const response = await fetch(`${FASTAPI_URL}/admin/train`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage(trainStatus, data.message, 'success');
                } else {
                    displayMessage(trainStatus, `Failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(trainStatus, `Network error: ${error.message}`, 'error');
            }
        });

        deleteBtn.addEventListener('click', async () => {
            clearMessage(deleteStatus);
            if (!authToken) {
                displayMessage(deleteStatus, "Please log in first.", 'error');
                return;
            }
            const recordId = deleteRecordId.value;
            if (!recordId) {
                displayMessage(deleteStatus, "Please enter a Record ID.", 'error');
                return;
            }
            try {
                const response = await fetch(`${FASTAPI_URL}/admin/records/${recordId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage(deleteStatus, data.message, 'success');
                } else {
                    displayMessage(deleteStatus, `Failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(deleteStatus, `Network error: ${error.message}`, 'error');
            }
        });

        correctBtn.addEventListener('click', async () => {
            clearMessage(correctStatus);
            if (!authToken) {
                displayMessage(correctStatus, "Please log in first.", 'error');
                return;
            }
            try {
                const response = await fetch(`${FASTAPI_URL}/annotator/correct_prediction`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage(correctStatus, data.message, 'success');
                } else {
                    displayMessage(correctStatus, `Failed: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                displayMessage(correctStatus, `Network error: ${error.message}`, 'error');
            }
        });

        // Initial UI update on page load
        updateAuthUI();
    </script>
</body>
</html>
